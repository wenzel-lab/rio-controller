# Rio Controller Configuration
# Pre-configuration: Full Features (64-bit) with Droplet Detection
#
# This configuration is for a Raspberry Pi running 64-bit Raspberry Pi OS
# with all components: strobe, camera, flow controller, heaters, and droplet detection.
# Uses camera-centric control mode with hardware trigger support.
#
# Usage:
#   1. Set environment variables (see below)
#   2. Run: python main.py
#
# Environment Variables (required):
#   export RIO_STROBE_CONTROL_MODE=camera-centric
#   export RIO_SIMULATION=false
#   export RIO_DROPLET_ANALYSIS_ENABLED=true

# Global simulation mode
# Set to false for hardware operation
simulation: false

# Camera configuration (64-bit Raspberry Pi HQ Camera recommended)
# HQ Camera sensor: Sony IMX477, ~4056 × 3040 pixels (12.3 megapixels)
# Standard V2 Camera sensor: Sony IMX219, 3280 × 2464 pixels (8 megapixels)
camera:
  type: rpi_hq           # Use "rpi_hq" for 64-bit Pi HQ Camera (picamera2 package)
                         # Use "rpi" for standard V2 camera on 64-bit
  # NOTE: Display resolution can now be adjusted via the web interface UI
  # Default resolution shown below (1024×768), can be changed in Camera Configuration tab
  # Available presets: 640×480, 800×600, 1024×768, 1280×960, 1920×1080
  # Full sensor resolution available for snapshots via UI:
  #   - V2 Camera: 3280×2464 pixels
  #   - HQ Camera: ~4056×3040 pixels
  width: 1024            # Default display width (can be changed in UI)
  height: 768            # Default display height (can be changed in UI)
  fps: 30                # Default framerate (automatically optimized via strobe timing)

# Strobe configuration (camera-centric control mode)
strobe:
  port: 24               # SPI device select port (GPIO pin 24, BOARD numbering)
  reply_pause_s: 0.1     # SPI reply pause time (100ms delay for PIC microcontroller to process commands)
  control_mode: camera-centric  # Camera-centric control (hardware trigger)
  trigger_gpio_pin: 18   # GPIO pin for camera frame trigger (BCM numbering, required)
  default_period_ns: 100000      # Default strobe pulse period (100 microseconds)
  max_period_ns: 16000000        # Maximum strobe pulse period (16 milliseconds)
  pre_padding_ns: 32             # Pre-padding before strobe pulse
  post_padding_ns: 20000000      # Post-padding after strobe pulse
  # Camera-centric mode: Camera frame callback triggers strobe via GPIO pin 18
  # Camera framerate is automatically calculated and optimized from strobe timing
  # Use the "Optimize" button in the web interface to fine-tune framerate

# Flow controller configuration (4 channels)
flow:
  enabled: true          # Enable flow controller
  port: 26               # SPI device select port (GPIO pin 26, BOARD numbering)
  reply_pause_s: 0.1     # SPI reply pause time (100ms delay for PIC processing)
  num_channels: 4        # Number of flow controller channels
  pressure_range: [0, 6000]    # Pressure range in mbar
  flow_range: [0, 1000]        # Flow range in ul/hr
  # Channels support both pressure and flow control modes
  # Control via web interface in Flow Controller tab

# Heater configuration (4 heater units)
heater:
  enabled: true          # Enable heaters
  num_units: 4           # Number of heater units
  reply_pause_s: 0.05    # SPI reply pause time (50ms - heaters respond faster)
  init_tries: 3          # Number of initialization attempts
  # Individual heater SPI ports (GPIO pins for device selection, BOARD numbering):
  #   - Heater 1: Port 31
  #   - Heater 2: Port 33
  #   - Heater 3: Port 32
  #   - Heater 4: Port 36
  # Each heater supports:
  #   - Temperature control (PID) via web interface
  #   - Power limiting
  #   - Autotune
  #   - Stirring

# Droplet detection (enabled)
droplet_detection:
  enabled: true          # Enable droplet detection and analysis
  # Droplet detection provides:
  #   - Real-time droplet counting
  #   - Size measurement
  #   - Histogram generation
  #   - ROI (Region of Interest) selection via web interface
  # Requires: numpy, opencv-python
  # Processing uses ROI coordinates selected via web interface
  # Access via Droplet Detection tab in web interface

# SPI configuration
spi:
  bus: 0                 # SPI bus number (SPI0 on Raspberry Pi)
  mode: 2                # SPI mode (clock polarity and phase)
  speed_hz: 30000        # SPI communication speed (30 kHz - slow for reliable PIC communication)
  # SPI ports (GPIO pins used for device selection, BOARD numbering):
  #   - Strobe: Port 24
  #   - Flow: Port 26
  #   - Heater 1: Port 31
  #   - Heater 2: Port 33
  #   - Heater 3: Port 32
  #   - Heater 4: Port 36

# Notes:
# - Firmware requirement: Must use new firmware with hardware trigger support
# - GPIO pin 18 (BCM) must be connected for camera-strobe synchronization
# - Camera must be enabled: sudo raspi-config -> Interface Options -> Camera -> Enable
# - Test camera: libcamera-hello  # 64-bit camera test command
# - SPI must be enabled: sudo raspi-config -> Interface Options -> SPI -> Enable
# - All SPI ports must be properly wired and device select lines configured
# - Flow controller and heaters require proper power supply and connections
# - Resolution and framerate:
#   * Display resolution: Adjustable via web interface (Camera Configuration tab)
#   * Snapshot resolution: Selectable via web interface (display or full sensor resolution)
#   * Framerate: Automatically calculated from strobe timing, optimized via "Optimize" button
# - Reply pause times allow PIC microcontrollers to process commands:
#   - 0.1s (strobe/flow): Allows ~10 commands/second (sufficient for configuration)
#   - 0.05s (heaters): Allows ~20 commands/second (heaters respond faster)
