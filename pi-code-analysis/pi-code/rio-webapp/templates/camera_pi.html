{% macro js_functions( cam, strobe ) %}
  var strobe = {{strobe|tojson}}
  var cam = {{cam|tojson}}
  
  function strobe_update_init()
  {
    $('#input_strobe_period_us').val( strobe.period_ns / 1000 );
    $('#input_strobe_wait_us').val( strobe.wait_ns / 1000 );
  }
  
  function cam_update()
  {
    // Initialize strobe buttons with default text if data not available
    if (typeof strobe !== 'undefined' && strobe !== null) {
      $('#strobe_enable').html( strobe.enable ? 'Enabled' : 'Disabled' );
      $('#btn_strobe_enable').html( strobe.enable ? 'Disable' : 'Enable' );
      
      $('#strobe_hold').html( strobe.hold ? 'On' : 'Off' );
      $('#btn_strobe_hold').html( strobe.hold ? 'Hold Off' : 'Hold On' );
      
      $('#strobe_period_us').html( strobe.period_ns ? (strobe.period_ns / 1000).toFixed(2) : '0' );
      $('#strobe_wait_us').html( strobe.wait_ns ? (strobe.wait_ns / 1000).toFixed(2) : '0' );
      $('#strobe_cam_time_us').html( strobe.cam_read_time_us || '0' );
      
      $('#strobe_framerate').html( strobe.framerate || '0' );
    } else {
      // Default values if strobe data not loaded yet
      $('#strobe_enable').html( 'Disabled' );
      $('#btn_strobe_enable').html( 'Enable' );
      $('#strobe_hold').html( 'Off' );
      $('#btn_strobe_hold').html( 'Hold On' );
      $('#strobe_period_us').html( '0' );
      $('#strobe_wait_us').html( '0' );
      $('#strobe_cam_time_us').html( '0' );
      $('#strobe_framerate').html( '0' );
    }
    $('#btn_cam_snapshot').html( "Snapshot" );
    $('#btn_cam_optimize').html( "Optimize" );
  }
  
  function cam_select() {
    socket.emit( 'cam', { cmd: 'select', parameters: { 'camera': $('#select_camera').val() } } );
  }
  function strobe_enable() {
    socket.emit( 'strobe', { cmd: 'enable', parameters: { 'on': strobe.enable ? 0 : 1 } } );
  }
  function strobe_hold() {
    socket.emit( 'strobe', { cmd: 'hold', parameters: { 'on': strobe.hold ? 0 : 1 } } );
  }
  function strobe_wait() {
    socket.emit( 'strobe', { cmd: 'timing', parameters: { 'wait_ns': ( $('#input_strobe_wait_us').val() * 1000 ), 'period_ns': strobe.period_ns } } );
  }
  function strobe_period() {
    socket.emit( 'strobe', { cmd: 'timing', parameters: { 'wait_ns': strobe.wait_ns, 'period_ns': ( $('#input_strobe_period_us').val() * 1000 ) } } );
  }
  function cam_optimize()
  {
    socket.emit( 'cam', { cmd: 'optimize', parameters: {} } );
  }
  function cam_snapshot()
  {
    socket.emit( 'cam', { cmd: 'snapshot', parameters: {} } );
  }
{% endmacro %}

{% macro js_doc_ready() %}
  strobe_update_init();
  cam_update();
  
  // Initialize ROI selector
  var roiSelector = null;
  var cameraImg = document.getElementById('camera_image');
  var roiCanvas = document.getElementById('roi_canvas');
  
  function initROISelector() {
    if (!cameraImg || !roiCanvas) {
      console.log('ROI selector: waiting for elements...');
      setTimeout(initROISelector, 100);
      return;
    }
    
    if (roiSelector) {
      return; // Already initialized
    }
    
    console.log('Initializing ROI selector...');
    roiSelector = new ROISelector(cameraImg, roiCanvas, socket);
    
    // Listen for ROI updates from server
    socket.on('roi', function(data) {
      if (data.roi) {
        // Scale ROI from image coordinates to canvas coordinates
        const scaleX = roiCanvas.width / cameraImg.naturalWidth;
        const scaleY = roiCanvas.height / cameraImg.naturalHeight;
        const scaledROI = {
          x: data.roi.x * scaleX,
          y: data.roi.y * scaleY,
          width: data.roi.width * scaleX,
          height: data.roi.height * scaleY
        };
        roiSelector.setROI(scaledROI);
        updateROIInfo();
      } else {
        // Clear ROI locally without sending command back to server
        // (to avoid infinite loop)
        roiSelector.clearROI(false); // false = don't send to server
        updateROIInfo();
      }
    });
    
    // Request current ROI from server
    socket.emit('roi', {cmd: 'get'});
  }
  
  // Wait for image to load
  if (cameraImg) {
    if (cameraImg.complete) {
      initROISelector();
    } else {
      cameraImg.addEventListener('load', initROISelector);
    }
  } else {
    // Try again after a short delay
    setTimeout(initROISelector, 500);
  }
  
  function updateROIInfo() {
    if (roiSelector && roiSelector.getROI()) {
      var roi = roiSelector.getROI();
      document.getElementById('roi_info').textContent = 
        'ROI: (' + Math.round(roi.x) + ', ' + Math.round(roi.y) + ') ' + 
        Math.round(roi.width) + 'Ã—' + Math.round(roi.height) + ' px';
    } else {
      document.getElementById('roi_info').textContent = 'No ROI selected';
    }
  }
  
  function clearROI() {
    if (roiSelector) {
      roiSelector.clearROI();
      // Send clear command to backend
      socket.emit('roi', {cmd: 'clear'});
      updateROIInfo();
    }
  }
  
  // Make function globally accessible
  window.clearROI = clearROI;
  
  socket.on( 'strobe', function( data ) {
    strobe = data;
    cam_update();
  });
  socket.on( 'cam', function( data ) {
    cam = data;
    cam_update();
  });
  
  // Update ROI info periodically
  setInterval(updateROIInfo, 500);
{% endmacro %}

{% macro html() %}
  <!-- Camera feed with ROI selector -->
  <div style="position: relative; display: inline-block;">
    <img id="camera_image" src="{{ url_for('video') }}" style="display: block; max-width: 100%; height: auto;">
    <canvas id="roi_canvas" style="position: absolute; top: 0; left: 0; pointer-events: auto; cursor: crosshair;"></canvas>
  </div>
  <div style="margin: 10px 0;">
    <button id="btn_roi_clear" onclick="clearROI()" style="width: 100px; margin-right: 10px;">Clear ROI</button>
    <span id="roi_info" style="margin-left: 20px; font-weight: bold;"></span>
  </div>
  <table style="border: 1px solid black; padding: 10px" cellpadding="2px">
      <tr>
        <td width=150>Enabled</td>
        <td width=100><p id='strobe_enable'></p></td>
        <td></td>
        <td><button id='btn_strobe_enable', onclick="strobe_enable()", style="width: 100px"></button></td>
      </tr>
      <tr>
        <td>Hold</td>
        <td><p id='strobe_hold'></p></td>
        <td></td>
        <td><button id='btn_strobe_hold', onclick="strobe_hold()", style="width: 100px"></button></td>
      </tr>
<!--
      <tr>
        <td>Wait (us)</td>
        <td><p id='strobe_wait_us'></p></td>
        <td><input type="number" id="input_strobe_wait_us" min="0" max="10000"></td>
        <td><button id='btn_strobe_wait_us', onclick="strobe_wait()", style="width: 100px">Set</button></td>
      </tr>
-->
      <tr>
        <td>Period (us)</td>
        <td><p id='strobe_period_us'></p></td>
        <td><input type="number" id="input_strobe_period_us" min="1" max="10000"></td>
        <td><button id='btn_strobe_period_us', onclick="strobe_period()", style="width: 100px">Set</button></td>
      </tr>
      <tr>
        <td>Cam Read Time (us)</td>
        <td><p id='strobe_cam_time_us'></p></td>
        <td></td>
        <td></td>
      </tr>
    <tr>
      <td>Framerate</td>
      <td><p id='strobe_framerate'></p></td>
      <td></td>
      <td><button id='btn_cam_optimize', onclick="cam_optimize()", style="width: 100px"></button></td>
    </tr>
    <tr>
      <td>Snapshot</td>
      <td></td>
      <td></td>
      <td><button id='btn_cam_snapshot', onclick="cam_snapshot()", style="width: 100px"></button></td>
    </tr>
  </table>
{% endmacro %}
