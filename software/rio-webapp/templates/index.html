<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rio Microfluidics Controller</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #FFFFFF; /* Pure White - Ocean Breeze */
        }
        .sidebar {
            background-color: #6c757d; /* Professional Grey */
            min-height: 100vh;
            padding: 20px;
        }
        .sidebar img {
            filter: brightness(0) invert(1);
        }
        .main-content {
            padding: 20px;
            background-color: #FFFFFF; /* Pure White */
        }
        .card {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            background-color: #FFFFFF; /* Pure White */
            border: 1px solid #E0E0E0; /* Light Gray - Ocean Breeze */
        }
        /* Ocean Breeze Color Palette Application */
        .btn-primary {
            background-color: #2196F3; /* Royal Blue */
            border-color: #2196F3;
        }
        .btn-primary:hover {
            background-color: #1565C0; /* Navy Blue */
            border-color: #1565C0;
        }
        .btn-success {
            background-color: #7FD3D3; /* Light Teal */
            border-color: #7FD3D3;
            color: #1565C0; /* Navy Blue text for contrast */
        }
        .btn-success:hover {
            background-color: #1565C0; /* Navy Blue */
            border-color: #1565C0;
            color: #FFFFFF;
        }
        .btn-outline-primary {
            color: #2196F3; /* Royal Blue */
            border-color: #2196F3;
        }
        .btn-outline-primary:hover {
            background-color: #2196F3; /* Royal Blue */
            border-color: #2196F3;
            color: #FFFFFF;
        }
        .badge.bg-info {
            background-color: #B3E5FC !important; /* Sky Blue */
            color: #1565C0; /* Navy Blue text */
        }
        .badge.bg-success {
            background-color: #7FD3D3 !important; /* Light Teal */
            color: #1565C0; /* Navy Blue text */
        }
        .nav-tabs .nav-link.active {
            background-color: #FFFFFF;
            border-color: #E0E0E0 #E0E0E0 #FFFFFF;
            color: #1565C0; /* Navy Blue */
        }
        .nav-tabs .nav-link {
            color: #666666;
        }
        .nav-tabs .nav-link:hover {
            color: #2196F3; /* Royal Blue */
        }
        /* UI Best Practices - Improved spacing and readability */
        .form-label {
            font-weight: 500;
            color: #1565C0; /* Navy Blue for labels */
            margin-bottom: 0.5rem;
        }
        .card-title, .card-subtitle {
            color: #1565C0; /* Navy Blue for headings */
        }
        .btn {
            transition: all 0.2s ease-in-out; /* Smooth transitions */
        }
        .btn:focus {
            box-shadow: 0 0 0 0.2rem rgba(33, 150, 243, 0.25); /* Focus ring */
        }
        input[type="number"]:focus,
        select:focus {
            border-color: #2196F3; /* Royal Blue focus */
            box-shadow: 0 0 0 0.2rem rgba(33, 150, 243, 0.25);
        }
        /* Improved contrast for text */
        .text-muted {
            color: #666666 !important;
        }
        /* Consistent button heights */
        .btn-sm {
            height: 32px;
            font-size: 0.875rem;
        }
        /* Better visual hierarchy */
        h1, h2, h3, h4, h5, h6 {
            color: #1565C0; /* Navy Blue */
            font-weight: 600; /* Semi-bold for better readability */
        }
        /* Improved font readability */
        body {
            font-weight: 400;
        }
        .form-label, label {
            font-weight: 600; /* Bold labels for better readability */
            font-size: 0.95rem;
        }
        .card-subtitle {
            font-weight: 600;
            font-size: 1rem;
        }
        .btn {
            font-weight: 500; /* Medium weight for buttons */
        }
        input[type="number"], input[type="text"], select {
            font-weight: 500; /* Medium weight for inputs */
            font-size: 0.95rem;
        }
        .badge {
            font-weight: 500;
        }
        small, .text-muted {
            font-weight: 500; /* Make small text more readable */
        }
        .camera-container {
            position: relative;
            display: inline-block;
            max-width: 100%;
        }
        #camera_image {
            display: block;
            max-width: 100%;
            height: auto;
        }
        #roi_canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: auto;
            cursor: crosshair;
        }
        /* ROI slider styling - vertical Y slider on left */
        .roi-y-slider-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px; /* Minimum height for initial render */
        }
        /* Custom vertical slider styling */
        #roi_y_range_slider {
            min-height: 100px; /* Minimum height */
            width: 20px !important;
            margin: 0 auto;
            display: block;
        }
        /* X-axis slider - matches image width */
        #roi_x_range_slider {
            width: 100% !important; /* Will be updated dynamically to match image width */
            height: 20px !important;
        }
        .debug-info {
            font-size: 0.85em;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-1 sidebar">
                <div class="text-center">
                    <i class="bi bi-droplet" style="font-size: 3rem; color: white;"></i>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-11 main-content">
                <h1 class="mb-4">Rio Microfluidics Controller</h1>
                
                <!-- Tabs Navigation -->
                <ul class="nav nav-tabs" id="mainTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="camera-view-tab" data-bs-toggle="tab" data-bs-target="#camera-view-pane" type="button" role="tab">
                            <i class="bi bi-camera"></i> Camera View
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="camera-config-tab" data-bs-toggle="tab" data-bs-target="#camera-config-pane" type="button" role="tab">
                            <i class="bi bi-gear"></i> Camera Config
                        </button>
                    </li>
                    {% if flow_enabled %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="flow-tab" data-bs-toggle="tab" data-bs-target="#flow-pane" type="button" role="tab">
                            <i class="bi bi-water"></i> Flow Control
                        </button>
                    </li>
                    {% endif %}
                    {% if heater_enabled %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="heater-tab" data-bs-toggle="tab" data-bs-target="#heater-pane" type="button" role="tab">
                            <i class="bi bi-thermometer-half"></i> Heaters
                        </button>
                    </li>
                    {% endif %}
                    {% if droplet_analysis_enabled %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="droplet-tab" data-bs-toggle="tab" data-bs-target="#droplet-pane" type="button" role="tab">
                            <i class="bi bi-droplet"></i> Droplet Detection
                        </button>
                    </li>
                    {% endif %}
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content mt-3" id="mainTabContent">
                    <!-- Camera View Tab -->
                    <div class="tab-pane fade show active" id="camera-view-pane" role="tabpanel">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <i class="bi bi-camera-video"></i> Camera Feed
                                        </h5>
                                        {% if cam.camera in ['rpi', 'rpi_hq', 'mako'] %}
                                            {% import 'camera_pi.html' as cam_html %}
                                        {% else %}
                                            {% import 'camera_none.html' as cam_html %}
                                        {% endif %}
                                        
                                        <div class="roi-container-wrapper" style="position: relative; display: inline-block; margin-bottom: 15px; width: 100%;">
                                            <div class="d-flex align-items-start justify-content-center">
                                                <!-- Left side: Y-axis slider (vertical) -->
                                                <div class="roi-y-slider-container" style="width: 50px; margin-right: 10px; padding-top: 20px; flex-shrink: 0;">
                                                    <div id="roi_y_range_slider"></div>
                                                    <div class="input-group input-group-sm mt-2" style="flex-direction: column;">
                                                        <input type="number" id="roi_y_min" class="form-control form-control-sm mb-1" min="0" max="{% if cam.display_height %}{{cam.display_height}}{% else %}1080{% endif %}" value="0" style="width: 100%;">
                                                        <input type="number" id="roi_y_max" class="form-control form-control-sm" min="0" max="{% if cam.display_height %}{{cam.display_height}}{% else %}1080{% endif %}" value="0" style="width: 100%;">
                                                    </div>
                                                </div>
                                                
                                                <!-- Center: Image with ROI overlay -->
                                                <div class="camera-container" style="flex: 1; max-width: 100%;">
                                                    <img id="camera_image" src="{{ url_for('video') }}" alt="Camera feed" class="img-fluid">
                                                    <!-- ROI preview canvas (read-only visual overlay) -->
                                                </div>
                                            </div>
                                            
                                            <!-- Bottom: X-axis slider (horizontal) -->
                                            <div class="roi-x-slider-container" style="margin-top: 10px; padding-left: 60px;">
                                                <div id="roi_x_range_slider" style="margin: 0;"></div>
                                                <div class="input-group input-group-sm mt-2" style="justify-content: center;">
                                                    <input type="number" id="roi_x_min" class="form-control form-control-sm" min="0" max="{% if cam.display_width %}{{cam.display_width}}{% else %}1920{% endif %}" value="0" style="width: 80px;">
                                                    <span class="input-group-text" style="padding: 0.25rem 0.5rem;">to</span>
                                                    <input type="number" id="roi_x_max" class="form-control form-control-sm" min="0" max="{% if cam.display_width %}{{cam.display_width}}{% else %}1920{% endif %}" value="0" style="width: 80px;">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <div class="card">
                                                <div class="card-body">
                                                    <div class="row g-3 align-items-center">
                                                        <div class="col-md-4 mb-2">
                                                            <button id="btn_cam_snapshot" onclick="cam_snapshot()" class="btn btn-primary w-100" style="height: 38px; font-weight: bold;">ðŸ“¸ SNAPSHOT</button>
                                                        </div>
                                                        <div class="col-md-4 mb-2">
                                                            <button id="btn_roi_clear" onclick="clearROI()" class="btn btn-outline-secondary w-100" style="height: 38px;">
                                                                <span style="font-size: 1.1em;">âœ•</span> Clear ROI
                                                            </button>
                                                        </div>
                                                        <div class="col-md-4 mb-2">
                                                            <span id="roi_info" class="badge bg-info w-100 d-block text-center" style="font-size: 0.9em; padding: 0.5rem; font-weight: 500;">No ROI selected</span>
                                                        </div>
                                                    </div>
                                                    <div class="row g-3">
                                                        <div class="col-md-4">
                                                            <label class="form-label">Strobe Illumination</label>
                                                            <button id="btn_strobe_enable" onclick="strobe_enable()" class="btn btn-secondary w-100" style="height: 38px; font-weight: bold;">DISABLED</button>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <label class="form-label">Strobe Duration (Î¼s)</label>
                                                            <div class="input-group">
                                                                <input type="number" id="input_strobe_period_us" class="form-control" min="1" max="10000" placeholder="Period">
                                                                <button id="btn_strobe_period_us" onclick="strobe_period()" class="btn btn-outline-primary">Set</button>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <label class="form-label">Continuous Light</label>
                                                            <button id="btn_strobe_hold" onclick="strobe_hold()" class="btn btn-secondary w-100" style="height: 38px; font-weight: bold;">OFF</button>
                                                        </div>
                                                    </div>
                                                    <div class="row g-3 mt-2">
                                                        <div class="col-md-6">
                                                            <button id="btn_cam_optimize" onclick="cam_optimize()" class="btn btn-success w-100" style="height: 38px;">Optimize</button>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <small class="text-muted d-block">Cam Read: <span id="strobe_cam_time_us"></span> Î¼s</small>
                                                            <small class="text-muted d-block">FPS: <span id="strobe_framerate"></span></small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Camera Config Tab -->
                    <div class="tab-pane fade" id="camera-config-pane" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h5 class="card-title">Camera Selection</h5>
                                        <div class="mb-3">
                                            <label for="select_camera" class="form-label">Select Camera Type:</label>
                                            <select id="select_camera" class="form-select" onchange="cam_select()">
                                                <option value="none">None</option>
                                                <option value="rpi"{% if cam.camera == "rpi" %} selected{%endif%}>Raspberry Pi Camera V2</option>
                                                <option value="rpi_hq"{% if cam.camera == "rpi_hq" %} selected{%endif%}>Raspberry Pi HQ Camera</option>
                                                <option value="mako"{% if cam.camera == "mako" %} selected{%endif%}>MAKO Camera</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h5 class="card-title">Display Resolution</h5>
                                        <div class="mb-3">
                                            <label for="select_display_resolution" class="form-label">Resolution for Web Streaming:</label>
                                            <select id="select_display_resolution" class="form-select" onchange="cam_set_resolution()">
                                                <option value="640x480"{% if cam.display_width == 640 and cam.display_height == 480 %} selected{%endif%}>640 Ã— 480 (Low - Fast)</option>
                                                <option value="800x600"{% if cam.display_width == 800 and cam.display_height == 600 %} selected{%endif%}>800 Ã— 600</option>
                                                <option value="1024x768"{% if cam.display_width == 1024 and cam.display_height == 768 %} selected{%endif%}>1024 Ã— 768 (Default)</option>
                                                <option value="1280x960"{% if cam.display_width == 1280 and cam.display_height == 960 %} selected{%endif%}>1280 Ã— 960</option>
                                                <option value="1920x1080"{% if cam.display_width == 1920 and cam.display_height == 1080 %} selected{%endif%}>1920 Ã— 1080 (High Quality)</option>
                                            </select>
                                            <small class="form-text text-muted">
                                                Current: <span id="current_display_resolution">{% if cam.display_width %}{{cam.display_width}} Ã— {{cam.display_height}}{% else %}1024 Ã— 768{% endif %}</span>
                                                <span id="resolution_change_status" class="text-info" style="display:none;"> (Changing...)</span>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Snapshot Resolution</h5>
                                        <div class="mb-3">
                                            <label for="select_snapshot_resolution" class="form-label">Resolution for Snapshots:</label>
                                            <select id="select_snapshot_resolution" class="form-select" onchange="cam_set_snapshot_resolution()">
                                                <option value="display"{% if cam.snapshot_resolution_mode == "display" or not cam.snapshot_resolution_mode %} selected{%endif%}>Use Display Resolution (Fast)</option>
                                                <option value="full"{% if cam.snapshot_resolution_mode == "full" %} selected{%endif%}>Full Sensor Resolution (High Quality)</option>
                                            </select>
                                            <small class="form-text text-muted">
                                                Full resolution: {% if cam.camera == "rpi_hq" %}4056 Ã— 3040 (HQ Camera){% else %}3280 Ã— 2464 (V2 Camera){% endif %}<br>
                                                <em>Note: Full resolution snapshots take longer to capture (~100-500ms) but provide maximum image quality.</em>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Debug Information</h5>
                                        <div class="debug-info">
                                            <p>Update Count: <span id="update_count">{{debug.update_count}}</span></p>
                                            <p>Camera: <span id="cam_type">{{cam.camera or 'None'}}</span></p>
                                            <p>Display Resolution: <span id="cam_display_res">{% if cam.display_width %}{{cam.display_width}} Ã— {{cam.display_height}}{% else %}1024 Ã— 768{% endif %}</span></p>
                                            <p>Snapshot Mode: <span id="cam_snapshot_mode">{{cam.snapshot_resolution_mode or 'display'}}</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Flow Control Tab -->
                    {% if flow_enabled %}
                    <div class="tab-pane fade" id="flow-pane" role="tabpanel">
                        {% for flow in flows %}
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Flow Controller {{loop.index}}</h5>
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label">Status</label>
                                        <p id="flow{{loop.index}}_status" class="form-control-plaintext"></p>
                                    </div>
                                    <div class="col-md-9">
                                        <label class="form-label">Control Mode</label>
                                        <p id="flow{{loop.index}}_control_mode" class="form-control-plaintext"></p>
                                        {% set flow_loop = loop %}
                                        {% for mode_str in flows[flow_loop.index-1].control_modes %}
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="input_flow{{flow_loop.index}}_control_mode" 
                                                   id="flow{{flow_loop.index}}_mode{{loop.index-1}}" 
                                                   value="{{loop.index-1}}" 
                                                   onclick="flow_control_mode({{flow_loop.index-1}})" 
                                                   {% if flows[flow_loop.index-1].control_mode == (loop.index-1) %} checked{%endif%}>
                                            <label class="form-check-label" for="flow{{flow_loop.index}}_mode{{loop.index-1}}">
                                                {{mode_str}}
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="row g-3 mt-2">
                                    <div class="col-md-6">
                                        <label class="form-label">Pressure (mbar)</label>
                                        <p id="flow{{loop.index}}_pressure_mbar_text" class="form-control-plaintext"></p>
                                        <div class="input-group">
                                            <input type="number" id="input_flow{{loop.index}}_pressure_mbar_target" class="form-control" min="0" max="10000">
                                            <button class="btn btn-primary" onclick="flow_pressure_mbar_target({{loop.index-1}})">Set</button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Flow (Î¼l/hr)</label>
                                        <p id="flow{{loop.index}}_flow_ul_hr_text" class="form-control-plaintext"></p>
                                        <div class="input-group">
                                            <input type="number" id="input_flow{{loop.index}}_flow_ul_hr_target" class="form-control" min="0" max="10000">
                                            <button class="btn btn-primary" onclick="flow_flow_ul_hr_target({{loop.index-1}})">Set</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <!-- Heaters Tab -->
                    {% if heater_enabled %}
                    <div class="tab-pane fade" id="heater-pane" role="tabpanel">
                        {% for heater in heaters %}
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Heater {{loop.index}}</h5>
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label">Status</label>
                                        <p id="heater{{loop.index}}_status" class="form-control-plaintext"></p>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">PID Enabled</label>
                                        <p id="heater{{loop.index}}_pid_enabled" class="form-control-plaintext"></p>
                                        <button id="btn_heater{{loop.index}}_pid_enabled" onclick="heater_pid_enable({{loop.index-1}})" class="btn btn-primary btn-sm w-100"></button>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Temperature (Â°C)</label>
                                        <p id="heater{{loop.index}}_temp_text" class="form-control-plaintext"></p>
                                        <div class="input-group input-group-sm">
                                            <input type="number" id="input_heater{{loop.index}}_temp_c_target" class="form-control" min="-50" max="100">
                                            <button class="btn btn-primary" onclick="heater_temp_c_target({{loop.index-1}})">Set</button>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Power Limit (%)</label>
                                        <p id="heater{{loop.index}}_power_limit" class="form-control-plaintext"></p>
                                        <div class="input-group input-group-sm">
                                            <input type="number" id="input_heater{{loop.index}}_power_limit" class="form-control" min="1" max="100">
                                            <button class="btn btn-primary" onclick="heater_set_power_limit({{loop.index-1}})">Set</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-3 mt-2">
                                    <div class="col-md-4">
                                        <label class="form-label">Autotune Status</label>
                                        <p id="heater{{loop.index}}_autotune_status" class="form-control-plaintext"></p>
                                        <div class="input-group input-group-sm">
                                            <input type="number" id="input_heater{{loop.index}}_autotune_target_temp" class="form-control" min="-50" max="100">
                                            <button id="btn_heater{{loop.index}}_autotune" onclick="heater_autotune({{loop.index-1}})" class="btn btn-warning"></button>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Stir Speed</label>
                                        <p id="heater{{loop.index}}_stir_speed" class="form-control-plaintext"></p>
                                        <div class="input-group input-group-sm">
                                            <input type="number" id="input_heater{{loop.index}}_stir_speed" class="form-control" min="0" max="100">
                                            <button id="btn_heater{{loop.index}}_stir" onclick="heater_stir({{loop.index-1}})" class="btn btn-secondary"></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <!-- Droplet Detection Tab -->
                    {% if droplet_analysis_enabled %}
                    <div class="tab-pane fade" id="droplet-pane" role="tabpanel">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-droplet"></i> Droplet Detection Control</h5>
                            </div>
                            <div class="card-body">
                                <div id="droplet_status" class="mb-3">
                                    <div class="alert alert-secondary">
                                        <strong>Status:</strong> Not Started
                                    </div>
                                </div>
                                <div class="btn-group mb-3" role="group">
                                    <button id="droplet_start_btn" type="button" class="btn btn-success">
                                        <i class="bi bi-play-circle"></i> Start Detection
                                    </button>
                                    <button id="droplet_stop_btn" type="button" class="btn btn-danger">
                                        <i class="bi bi-stop-circle"></i> Stop Detection
                                    </button>
                                    <button id="droplet_reset_btn" type="button" class="btn btn-warning">
                                        <i class="bi bi-arrow-clockwise"></i> Reset
                                    </button>
                                    <button id="droplet_status_btn" type="button" class="btn btn-info">
                                        <i class="bi bi-info-circle"></i> Get Status
                                    </button>
                                    <button id="droplet_export_btn" type="button" class="btn btn-primary">
                                        <i class="bi bi-download"></i> Export Data
                                    </button>
                                </div>
                                <div class="alert alert-info">
                                    <small>
                                        <strong>Note:</strong> Set ROI in Camera View tab before starting detection.
                                        Detection processes frames from the selected ROI region.
                                        <br>
                                        <strong>Calibration:</strong> Configure pixel_ratio (um/px) via config API to display sizes in micrometers.
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Droplet Histograms</h5>
                            </div>
                            <div class="card-body">
                                <div id="droplet_histogram_container" class="row">
                                    <!-- Histograms will be created by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery UI for dual-handle range sliders -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/ui-lightness/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <style>
        /* Style ROI range sliders to match Ocean Breeze palette */
        /* X-axis slider (jQuery UI) */
        #roi_x_range_slider .ui-slider-range {
            background: #2196F3 !important; /* Royal Blue */
            border-color: #2196F3 !important;
        }
        #roi_x_range_slider .ui-slider-handle {
            border-color: #1565C0 !important; /* Navy Blue */
            background: #2196F3 !important; /* Royal Blue */
        }
        #roi_x_range_slider .ui-slider-handle:hover {
            background: #7FD3D3 !important; /* Light Teal */
        }
        /* Custom vertical Y-axis slider - handles styled in JavaScript */
        #roi_y_range_slider div[style*="background: #2196F3"]:hover {
            background: #7FD3D3 !important; /* Light Teal on hover */
        }
    </style>
    <!-- Socket.IO client v2.3.0 - compatible with Flask-SocketIO 4.3.2 + python-engineio 3.13.2 -->
    <!-- Socket.IO client - upgraded to v4.7.2 for compatibility with Flask-SocketIO 5.x -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- ROI Selector - Range slider-based (dual handles for min/max) -->
    <script src="{{ url_for('static', filename='roi_selector_range.js') }}"></script>
    <script src="{{ url_for('static', filename='droplet_histogram.js') }}"></script>
    
    <script type="text/javascript">
        // Initialize Socket.IO FIRST (functions need it)
        // Flask-SocketIO 5.x with Engine.IO 4.x requires allowEIO3 for backward compatibility
        var socket = io({
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionAttempts: 5,
            // Allow Engine.IO 3.x protocol for compatibility with Flask-SocketIO 5.x
            allowEIO3: true
        });
        
        // Debug: Log connection state
        console.log('Socket.IO initialized, connecting...');
        console.log('Socket connection state:', socket.connected);
        
        // Log connection attempts
        socket.on('connect_error', function(error) {
            console.error('Socket.IO connection error:', error);
        });
        
        socket.on('connect_timeout', function() {
            console.error('Socket.IO connection timeout');
        });
        
        // Include camera functions (after socket is defined so functions can use it)
        {{ cam_html.js_functions( cam, strobe ) }}
        
        var heaters = {{heaters|tojson}};
        var flows = {{flows|tojson}};
        
        // ROI update function
        function updateROIInfo() {
            var roiInfo = document.getElementById('roi_info');
            if (roiInfo && typeof roiSelectorRange !== 'undefined' && roiSelectorRange) {
                var roi = roiSelectorRange.getROI();
                if (roi) {
                    roiInfo.textContent = 
                        'ROI: ' + roi.width + 'Ã—' + roi.height + ' px';
                    roiInfo.className = 'badge bg-success';
                } else {
                    roiInfo.textContent = 'No ROI selected';
                    roiInfo.className = 'badge bg-info';
                }
            }
        }
        
        // Make updateROIInfo globally accessible
        window.updateROIInfo = updateROIInfo;
        
        // Initialize range slider-based ROI selector (dual handles for min/max)
        var roiSelectorRange = null;
        var cameraImg = document.getElementById('camera_image');
        
        function initROISelectorRange() {
            if (!cameraImg) {
                setTimeout(initROISelectorRange, 100);
                return;
            }
            
            if (roiSelectorRange) {
                return; // Already initialized
            }
            
            // Get max dimensions from camera data
            const maxWidth = {% if cam.display_width %}{{cam.display_width}}{% else %}1920{% endif %};
            const maxHeight = {% if cam.display_height %}{{cam.display_height}}{% else %}1080{% endif %};
            
            // Wait for jQuery UI to be loaded
            if (typeof $.fn.slider === 'undefined') {
                setTimeout(initROISelectorRange, 100);
                return;
            }
            
            roiSelectorRange = new ROISelectorRange(cameraImg, socket, maxWidth, maxHeight);
            window.roiSelectorRange = roiSelectorRange; // Make globally accessible
        }
        
        // Wait for image to load and jQuery UI
        if (cameraImg) {
            if (cameraImg.complete) {
                initROISelectorRange();
            } else {
                cameraImg.addEventListener('load', initROISelectorRange);
            }
        } else {
            setTimeout(initROISelectorRange, 500);
        }
        
        // Clear ROI function (for button)
        function clearROI() {
            if (roiSelectorRange) {
                roiSelectorRange.clearROI();
            }
        }
        window.clearROI = clearROI;
        
        // Heater functions
        function heaters_update_init() {
            for (var i = 0; i <= 3; i++) {
                $('#input_heater' + (i + 1) + '_temp_c_target').val(heaters[i].temp_c_target.toString());
                $('#input_heater' + (i + 1) + '_autotune_target_temp').val(heaters[i].autotune_target_temp.toString());
                $('#input_heater' + (i + 1) + '_power_limit').val(heaters[i].power_limit.toString());
                $('#input_heater' + (i + 1) + '_stir_speed').val(heaters[i].stir_speed_target.toString());
            }
        }
        
        function heaters_update() {
            for (var i = 0; i <= 3; i++) {
                $('#heater' + (i + 1) + '_pid_enabled').html(heaters[i].pid_enabled ? "Enabled" : "Disabled");
                $('#btn_heater' + (i + 1) + '_pid_enabled').html(heaters[i].pid_enabled ? 'Disable' : 'Enable');
                $('#heater' + (i + 1) + '_autotune_status').html(heaters[i].autotune_status);
                $('#btn_heater' + (i + 1) + '_autotune').html(heaters[i].autotuning ? 'Stop' : 'Start');
                $('#heater' + (i + 1) + '_power_limit').html(heaters[i].power_limit);
                $('#heater' + (i + 1) + '_stir_speed').html(heaters[i].stir_speed_text);
                $('#btn_heater' + (i + 1) + '_stir').html(heaters[i].stir_enabled ? 'Stop' : 'Start');
                $('#heater' + (i + 1) + '_status').html(heaters[i].status);
                $('#heater' + (i + 1) + '_temp_text').html(heaters[i].temp_text);
            }
        }
        
        // Flow functions
        function flows_update_init() {
            for (var i = 0; i <= 3; i++) {
                $('#input_flow' + (i + 1) + '_pressure_mbar_target').val(flows[i].pressure_mbar_target.toString());
            }
        }
        
        function flows_update() {
            for (var i = 0; i <= 3; i++) {
                $('#flow' + (i + 1) + '_status').html(flows[i].status);
                $('#flow' + (i + 1) + '_pressure_mbar_text').html(flows[i].pressure_mbar_text);
                $('#flow' + (i + 1) + '_flow_ul_hr_text').html(flows[i].flow_ul_hr_text);
                var firmwareMode = flows[i].control_mode;
                $('#flow' + (i + 1) + '_control_mode').html(flows[i].control_modes[firmwareMode]);
                $("input:radio[name=input_flow" + (i + 1) + "_control_mode][value='" + firmwareMode + "']").prop("checked", true);
            }
        }
        
        // Socket.IO event handlers
        $(document).ready(function() {
            {{ cam_html.js_doc_ready() }}
            
            heaters_update_init();
            flows_update_init();
            heaters_update();
            flows_update();
            
            socket.on('connect', function() {
                console.log('âœ… WebSocket connected! Socket.connected:', socket.connected);
                // Try to flush any queued events
                console.log('SendBuffer length:', socket.sendBuffer.length);
            });
            
            socket.on('disconnect', function() {
                console.log('âŒ WebSocket connection lost!');
            });
            
            // Check connection status periodically
            setTimeout(function() {
                console.log('Connection check after 2s - socket.connected:', socket.connected);
                if (!socket.connected) {
                    console.error('âš ï¸ Socket still not connected after 2 seconds!');
                    console.log('Attempting manual connect...');
                    socket.connect();
                }
            }, 2000);
            
            socket.on('reload', function(data) {
                location.reload(true);
            });
            
            socket.on('debug', function(data) {
                $('#update_count').html(data.update_count);
            });
            
            socket.on('strobe', function(data) {
                strobe = data;
                cam_update();
            });
            
            socket.on('cam', function(data) {
                cam = data;
                cam_update();
            });
            
            socket.on('heaters', function(data) {
                heaters = data;
                heaters_update();
            });
            
            socket.on('flows', function(data) {
                flows = data;
                flows_update();
            });
            
            // Droplet detection event handlers
            socket.on('droplet:histogram', function(data) {
                if (window.dropletHistogram) {
                    window.dropletHistogram.updateHistograms(data);
                }
            });
            
            socket.on('droplet:statistics', function(data) {
                if (window.dropletHistogram) {
                    window.dropletHistogram.updateStatistics(data);
                }
            });
            
            socket.on('droplet:status', function(data) {
                if (window.dropletHistogram) {
                    window.dropletHistogram.updateStatus(data);
                }
            });
            
            socket.on('droplet:error', function(data) {
                console.error('Droplet detection error:', data.message);
                alert('Droplet Detection Error: ' + data.message);
            });
        });
        
        // Control functions
        function cam_select() {
            socket.emit('cam_select', { cmd: 'select', parameters: { 'camera': $('#select_camera').val() } });
        }
        
        function cam_set_resolution() {
            var preset = $('#select_display_resolution').val();
            $('#resolution_change_status').show();
            socket.emit('cam', { cmd: 'set_resolution', parameters: { 'preset': preset } });
        }
        
        function cam_set_snapshot_resolution() {
            var mode = $('#select_snapshot_resolution').val();
            socket.emit('cam', { cmd: 'set_snapshot_resolution', parameters: { 'mode': mode } });
        }
        
        // Update UI when camera data changes
        socket.on('cam', function(data) {
            if (data.display_width && data.display_height) {
                var resText = data.display_width + ' Ã— ' + data.display_height;
                $('#current_display_resolution').text(resText);
                $('#cam_display_res').text(resText);
                // Update dropdown to match (if preset exists)
                var preset = data.display_width + 'x' + data.display_height;
                if ($('#select_display_resolution option[value="' + preset + '"]').length > 0) {
                    $('#select_display_resolution').val(preset);
                }
                // Hide resolution change status
                $('#resolution_change_status').hide();
            }
            if (data.snapshot_resolution_mode) {
                $('#cam_snapshot_mode').text(data.snapshot_resolution_mode);
                $('#select_snapshot_resolution').val(data.snapshot_resolution_mode);
            }
            if (data.camera) {
                $('#cam_type').text(data.camera);
            }
        });
        
        function heater_temp_c_target(index) {
            socket.emit('heater', { cmd: 'temp_c_target', parameters: { 'index': index, 'temp_c_target': $('#input_heater' + (index + 1) + '_temp_c_target').val() } });
        }
        
        function heater_pid_enable(index) {
            socket.emit('heater', { cmd: 'pid_enable', parameters: { 'index': index, 'on': !heaters[index].pid_enabled } });
        }
        
        function heater_autotune(index) {
            socket.emit('heater', { cmd: 'autotune', parameters: { 'index': index, 'on': !heaters[index].autotuning, 'temp': $('#input_heater' + (index + 1) + '_autotune_target_temp').val() } });
        }
        
        function heater_set_power_limit(index) {
            socket.emit('heater', { cmd: 'power_limit_pc', parameters: { 'index': index, 'power_limit_pc': $('#input_heater' + (index + 1) + '_power_limit').val() } });
        }
        
        function heater_stir(index) {
            socket.emit('heater', { cmd: 'stir', parameters: { 'index': index, 'on': !heaters[index].stir_enabled, 'speed': $('#input_heater' + (index + 1) + '_stir_speed').val() } });
        }
        
        function flow_pressure_mbar_target(index) {
            socket.emit('flow', { cmd: 'pressure_mbar_target', parameters: { 'index': index, 'pressure_mbar_target': $('#input_flow' + (index + 1) + '_pressure_mbar_target').val() } });
        }
        
        function flow_flow_ul_hr_target(index) {
            socket.emit('flow', { cmd: 'flow_ul_hr_target', parameters: { 'index': index, 'flow_ul_hr_target': $('#input_flow' + (index + 1) + '_flow_ul_hr_target').val() } });
        }
        
        function flow_control_mode(index) {
            socket.emit('flow', { cmd: 'control_mode', parameters: { 'index': index, 'control_mode': $('input:radio[name=input_flow' + (index + 1) + '_control_mode]:checked').val() } });
        }
    </script>
</body>
</html>

