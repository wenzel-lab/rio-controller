# hardware-modules/heating-stirring/sample_holder_pic/ — Sample-holder PIC firmware (heater + stirrer)

Firmware for the sample-holder module PIC (heater + stirring). The host (Raspberry Pi) talks to this firmware over SPI to set temperature targets, control PID/autotune, control stirring, and query status. The host-side counterpart is `software/drivers/heater.py` (used via `software/controllers/heater_web.py`).

## What’s in this folder

- **Application logic + protocol switch**: `main.c`
- **SPI framing / transport**: `spi.c`, `spi.h`
- **Non-volatile storage**:
  - `storage.c/h` (persisted settings/state)
  - `eeprom.c/h` (EEPROM access)
- **Generated peripheral code**: `mcc_generated_files/` (generated by MCC; avoid hand edits)

## Build and flash (MPLAB X)

- Open the `sample_holder_pic` MPLAB X project
- Select a programmer configuration (PICkit/Snap, etc.)
- Build/flash

Device/toolchain details live in `nbproject/` and the MCU headers referenced by `main.c`.

## SPI interface (host protocol)

### Device identity

`main.c` defines the device ID string as **`"SAMPLE_HOLDER"`**. The host verifies this via the `GET_ID` packet.

### Packet framing

SPI packets are framed as:

- `[STX=2][size][packet_type][data...][checksum]`
- checksum is chosen so that the sum of all bytes modulo 256 equals 0

See `spi.c` (e.g., `spi_packet_read()` and related helpers).

### Packet types (source of truth: `main.c`)

- `1` — **GET_ID**
- `2` — **TEMP_SET_TARGET**
- `3` — **TEMP_GET_TARGET**
- `4` — **TEMP_GET_ACTUAL**
- `5` — **PID_SET_COEFFS**
- `6` — **PID_GET_COEFFS**
- `7` — **PID_SET_RUNNING**
- `8` — **PID_GET_STATUS**
- `9` — **AUTOTUNE_SET_RUNNING**
- `10` — **AUTOTUNE_GET_RUNNING**
- `11` — **AUTOTUNE_GET_STATUS**
- `12` — **STIR_SET_RUNNING**
- `13` — **STIR_GET_STATUS**
- `14` — **STIR_SPEED_GET_ACTUAL**
- `15` — **HEAT_POWER_LIMIT_SET**
- `16` — **HEAT_POWER_LIMIT_GET**

The host driver should treat the `main.c` packet switch as authoritative for payload formats and return codes.

## Persisted parameters

`storage.c/h` persists a compact struct including PID coefficients, temperature targets (scaled), run-on-start behavior, and heater power limit. If you change storage layout, update versioning and any host-side assumptions.

## AI-generated notice

This file was AI-generated and may contain errors. Please verify against source code and hardware behavior.
- Date: 2025-12-30
- Model: GPT-5.2
- Maintenance: If you change firmware behavior or host protocol, update this document.


