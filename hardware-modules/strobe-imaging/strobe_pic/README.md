# hardware-modules/strobe-imaging/strobe_pic/ — Strobe Imaging PIC firmware

Firmware for the Strobe Imaging module’s PIC. The host (Raspberry Pi) talks to this firmware over SPI to enable/disable the strobe, configure timing, and read back camera read-time. The host-side counterpart is `software/drivers/strobe.py` (used via `software/controllers/strobe_cam.py`).

## What’s in this folder

- **Application logic**: `main.c`
- **SPI framing / transport**: `spi.c`, `spi.h`
- **Shared definitions**: `common.h`
- **Generated peripheral code**: `mcc_generated_files/` (generated by Microchip Code Configurator; avoid hand edits)
- **Alternative hardware-trigger implementation**:
  - `main_hardware_trigger.c`
  - `interrupt_manager_hardware_trigger.c`

Generated/build artifacts often present in-tree:

- `build/`, `dist/`: build outputs (e.g., production `.hex`)

## Build and flash (MPLAB X)

- Open the `strobe_pic` project in **MPLAB X IDE**
- Select a programmer configuration (PICkit/Snap, etc.) via the project configuration
- Build/flash

Device/toolchain details are encoded in the MPLAB project files (`nbproject/`) and MCU headers referenced by `main.c`.

## SPI interface (host protocol)

### Packet framing

SPI packets are framed as:

- `[STX=2][size][packet_type][data...][checksum]`
- checksum is chosen so that the sum of all bytes modulo 256 equals 0

See `spi.c` (e.g., `spi_packet_read()` and related helpers).

### Packet types (source of truth: `main.c`)

`main.c` defines packet types and payload interpretation:

- `1` — **SET_STROBE_ENABLE**
- `2` — **SET_STROBE_TIMING**
- `3` — **SET_STROBE_HOLD**
- `4` — **GET_CAM_READ_TIME**

The host driver should treat the `main.c` packet switch as authoritative for payload formats and return codes.

## Compatibility notes

- Host-side strobe behavior has multiple orchestration modes (strobe-centric vs camera-centric). Ensure the selected host mode is compatible with the firmware/trigger wiring you’re using.
- If you use the hardware-trigger variant, verify the GPIO trigger pin wiring and the corresponding interrupt configuration.

## AI-generated notice

This file was AI-generated and may contain errors. Please verify against source code and hardware behavior.
- Date: 2025-12-30
- Model: GPT-5.2
- Maintenance: If you change firmware behavior or host protocol, update this document.


