# hardware-modules/pressure-flow-control/pressure_and_flow_pic/ — Pressure/flow PIC firmware

Firmware for the pressure/flow module PIC. The host (Raspberry Pi) talks to this firmware over SPI to set pressure/flow targets, select control modes, and get live readings. The host-side counterpart is `software/drivers/flow.py` (used via `software/controllers/flow_web.py`).

## What’s in this folder

- **Application logic + protocol switch**: `main.c`
- **SPI framing / transport**: `spi.c`, `spi.h`
- **I2C-attached devices**:
  - ADC: `ads1115.c/h`
  - I2C mux: `pca9544a.c/h`
  - Flow sensor: `sensirion_lg16.c/h`
- **Non-volatile storage**:
  - `storage.c/h` (persistent FPID constants and versioning)
  - `eeprom.c/h` (EEPROM access)
- **Generated peripheral code**: `mcc_generated_files/` (generated by MCC; avoid hand edits)

## Build and flash (MPLAB X)

- Open the `pressure_and_flow_pic` MPLAB X project
- Select a programmer configuration (PICkit/Snap, etc.)
- Build/flash

Device/toolchain details live in `nbproject/` and the MCU headers referenced by `main.c`.

## SPI interface (host protocol)

### Device identity

`main.c` defines the device ID string as **`"MICROFLOW"`**. The host verifies this via the `GET_ID` packet.

### Packet framing

SPI packets are framed as:

- `[STX=2][size][packet_type][data...][checksum]`
- checksum is chosen so that the sum of all bytes modulo 256 equals 0

See `spi.c` (e.g., `spi_packet_read()` and related helpers).

### Packet types (source of truth: `main.c`)

`main.c` defines packet types and payload interpretation:

- `1` — **GET_ID**
- `2` — **SET_PRESSURE_TARGET**
- `3` — **GET_PRESSURE_TARGET**
- `4` — **GET_PRESSURE_ACTUAL**
- `5` — **SET_FLOW_TARGET**
- `6` — **GET_FLOW_TARGET**
- `7` — **GET_FLOW_ACTUAL**
- `8` — **SET_CONTROL_MODE**
- `9` — **GET_CONTROL_MODE**
- `10` — **SET_FPID_CONSTS**
- `11` — **GET_FPID_CONSTS**

The host driver should treat the `main.c` packet switch as authoritative for payload formats and return codes.

## Persisted parameters

`storage.c/h` persists FPID constants per channel and an EEPROM version field. If you change storage layout, update versioning and any host-side assumptions.

## AI-generated notice

This file was AI-generated and may contain errors. Please verify against source code and hardware behavior.
- Date: 2025-12-30
- Model: GPT-5.2
- Maintenance: If you change firmware behavior or host protocol, update this document.


